shuriken <- c(
                 1, 1, 2, 3, 5, 1, 6, 0, 
                 5, 5, 3, 1, 4, 5, 2, 0, 
                 4, 4, 1, 5, 6, 4, 3, 0, 
                 6, 6, 5, 4, 2, 6, 1, 0, 
                 2, 2, 4, 6, 3, 2, 5, 0, 
                 3, 3, 6, 2, 1, 3, 4, 0
)

next_pair <- function(v) {
  a_new <- (v[1] + shuriken[v[2]] - 1) %% 48 + 1
  b_new <- (v[2] + shuriken[a_new] - 1) %% 48 + 1
  return(c(a_new, b_new))
}

compute_iterates <- function(v, n_its) {
  iterates <- matrix(0, n_its, 2)
  for (i in 1:n_its) {
    iterates[i, ] <- v
    v <- next_pair(v)
  }
  print(dim(unique(iterates))[1])
  iterates[1:dim(unique(iterates))[1],]
}

cycle1 <- compute_iterates(c(1,1), 2000)
cycle2 <- compute_iterates(c(1,2), 2000)
cycle3 <- compute_iterates(c(2,26), 2000)
cycle4 <- compute_iterates(c(3,27), 2000)

plot(cycle1, col = 'gray66')
points(cycle2, col='coral')
points(cycle3, col='blue')
points(cycle4, col='green')


t(cycle3)
#   2    8   14   15   17   20   23   24   25    27    27    31    36    41    44
#  26   26   31   33   37   42   45   45    3     8    13    14    20    23    25

t(cycle4)
#    3    8   13   14   20   23   25   26   26    31    33    37    42    45    45
#   27   27   31   36   41   44    2    8   14    15    17    20    23    24    25



seqz <- shuriken[cycle1[, 1]]
paste0(seqz, collapse='')
# 112133555664130633532565242033401633144636025033311132045044262331122044466020321542566224360560525666622333211052565224306413534550454666514523310544156616321141363155444255330105351026251265504466662030136441443614364366051444444446122211552432214011025551406023455553060552625102041643406334164424166424314125124456503061225514522543503613355266602614111510532233326311504664522203325665120445411333215031220443510251110510556306666634555204444646023203621265504655033064534216414322664511051436261456445034401024233616652044336625130111254466622030105436656242215611264503333330150456542250310252241020462632266426051102433161406112351441655044623362343014665133123315516523203015144061660221653544162114333310524143426021105560566133334110550426021325554066022323660513544062442534204444342463430105322563012614435120313301445654423623353204450333116052450464566111354524413306135321131655443342125324012044462433361330155221554061120315034556144331605542132040112315533411020433453401635640140111056522042251116634161253113116054132260241551446552622362440155114540644165511353422460503260532656240132163435226311

table(seqz)
#   0   1   2   3   4   5   6 
# 123 172 157 170 179 164 154 

table(seqz[1:1118], seqz[2:1119])
#    0  1  2  3  4  5  6
# 0  0 21 19 20 23 25 15
# 1 22 39 21 24 26 17 22
# 2 23 19 29 18 22 24 22
# 3 18 22 25 48 22 17 18
# 4 18 23 21 26 49 24 18
# 5 20 27 21 18 19 36 23
# 6 22 20 21 16 18 21 36

seqz <- shuriken[cycle1[, 2]]
paste0(seqz, collapse='')
# 113503066023633365245616232241116401504236611150314541134406223135105554442266533425504066255211655560203102516615166022334236121022223011444520466311164156210232341204466503066221355514566425220350446622236423012646245301131050406021256553063560245503360553226636640115533063216335562115441462660231252166422263320352553326025211105214556630605641665222503344365354544102223015241660522032311551306412633313011154411665422244012111406656055110504222231221152434223605503346622463342105046102225633114444063320335563401660261115034366122463520350406622664530134136542503615554014644222261151511433660225533125350406263340112654556661024262035306662430612154454064653610235526641226633642255044065223311642046056222531315534415666133301654013066644534411561446602203141055153406632031354550406561165544443646432214515544366420446021610546126524115555453061162344254406102631130140116622350321204460512263231125554436204221022355041022250366343363065406536111324463355421240102605533246662332243555211564452203330160550462663524013511146465244333435541021353213011443062222203530643612203333551555646634155153146642436340
table(seqz)
#   0   1   2   3   4   5   6 
# 126 159 175 161 155 166 177
table(seqz[1:1118], seqz[2:1119])
#    0  1  2  3  4  5  6
# 0  0 20 23 22 18 16 26
# 1 19 43 19 18 16 25 19
# 2 18 22 55 23 19 18 20
# 3 23 19 16 35 20 25 23
# 4 24 19 21 16 35 16 24
# 5 22 14 20 22 23 46 19
# 6 20 21 21 25 24 20 46

# Positions of all doubles
gcyc <- as.numeric(t(cycle1))
doubles <- cbind(gcyc[which(gcyc==gcyc[c(2:2238, 1)])],
      which(gcyc==gcyc[c(2:2238, 1)]))

#      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14] [,15] [,16] [,17] [,18] [,19]
# [1,]    1    2   11   26   20    7   28   18   22    34    38    47     4    12    35    27    30    36     5
# [2,]    1    3   11   18   42   66  116  143  145   152   206   246   250   449   496   673   869   871   879
#      [,20] [,21] [,22] [,23] [,24] [,25] [,26] [,27] [,28] [,29] [,30] [,31] [,32] [,33] [,34] [,35] [,36] [,37]
# [1,]    10    31    33    37    43    42     9    14    21    23    25    13    17    44     3    45    19    46
# [2,]   881  1266  1270  1300  1304  1331  1343  1345  1349  1608  1763  1788  1790  1808  1816  1841  1859  1879
#      [,38] [,39] [,40] [,41] [,42]
# [1,]    15    39     6    29    41
# [2,]  1918  2048  2061  2104  2112

## Break up the large segments into smaller segments

search_pair <- function(a1, a2, target=gcyc) {
  which((target[1:(length(target)-1)]==a1) & (target[2:length(target)]==a2))
}

manual_split <- function(begin, end, target=gcyc) {
  max_gap <- sapply(1:48, function(i) max(diff(c(1, which(target[begin:end]==i), end-begin+1))))
  max_gap[max_gap < 0] <- Inf
  nhits <- sapply(1:48, function(i) sum(target[begin:end]==i))
  rights <- sapply(1:48, function(i) {
    inds <- which(target==i)
    inds <- inds[(inds >= begin) & (inds <= end)]
    inds
    right <- c(target, target[1])[inds + 1]
    paste(i, '/', paste0(right, collapse=","))
  })
  tab <- data.frame(max_gap, nhits, rights)
  tab <- tab[order(tab$max_gap),]
  tab<- tab[order(tab$nhits),]
  tab
}

split_seq <- function(begin, end, target = gcyc) {
  max_gap <- sapply(1:48, function(i) max(diff(c(1, which(target[begin:end]==i), end-begin+1))))
  max_gap[max_gap < 0] <- Inf
  print(min(max_gap))
  splitter <- which(max_gap==min(max_gap))[1]
  inds <- which(target==splitter)
  inds <- inds[(inds >= begin) & (inds <= end)]
  inds
  right <- c(target, target[1])[inds + 1]
  list(splitter=splitter, table=rbind(right, inds))
}

# 10/10 -> 31/31
manual_split(881, 1265)
# 16/(12,17,33,43,4,42,45,30,41,34,3)

# 4/4 -> 12/12
manual_split(250, 448)
# 12/(11,27,3,30,23)

# 35/35 -> 27/27 -> 30/30
manual_split(496, 868)
# 48/(41,9,37,17,10,21,15)

# 21/21 -> 23/23 -> 25/25
manual_split(1349, 1762)
# 33/(28,40,42,9,6,11,41,44,30,22,46,4)

# 15/15 -> 39/39
manual_split(1918, 2047)
# 35/(27,10,15,14,46)

# 41/41 -> 1/1
manual_split(2112, 2238)
# 34/(22,13,1)

# Occurences of loc 10

k <- 10
inds <- which(gcyc==k)
k
max(diff(c(inds, 2238 + inds[1])))
rbind(gcyc[inds + 1], inds, diff(c(inds, 2238 + inds[1])))

# [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14] [,15] [,16] [,17] [,18] [,19]
#    9    8   13   25   12    1   24   29   26     6    19     2    44    20    48     5    27     3    22
#   36  138  140  170  253  359  366  368  394   478   514   537   655   666   687   689   756   779   788
#  102    2   30   83  106    7    2   26   84    36    23   118    11    21     2    67    23     9    38
# [,20] [,21] [,22] [,23] [,24] [,25] [,26] [,27] [,28] [,29] [,30] [,31] [,32] [,33] [,34] [,35] [,36] [,37]
#    23    34    10    15    28    43    38    30    32    37    33    46    16    21     4    36    39    42
#   826   847   881   882   923   972   987  1090  1148  1150  1180  1252  1287  1289  1312  1380  1429  1474
#    21    34     1    41    49    15   103    58     2    30    72    35     2    23    68    49    45    39
# [,38] [,39] [,40] [,41] [,42] [,43] [,44] [,45] [,46] [,47] [,48]
#    17    47    18    41    14    11    40    45    35     7    31
#  1513  1596  1632  1743  1853  1915  1943  1945  1988  2032  2163
#    83    36   111   110    62    28     2    43    44   131   111

